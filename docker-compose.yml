services:
  # DATABASE #
  postgres:
    image: postgres:18
    container_name: postgres
    restart: always
    expose:
      - "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file:
      - ./config/deploy/postgres.env
    environment:
      - POSTGRES_DB=mytube_db
      - POSTGRES_USER=mytube_user
    
  mongo:
    image: mongo:7.0
    container_name: mongo
    restart: always
    expose:
      - "27017"
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/var/lib/mongo/data
    env_file:
      - ./config/deploy/mongo.env
    environment:
      - MONGO_INITDB_ROOT_USERNAME=recommendation_service_db

  # SERVICE #
  mytube:
    build: ./mytube
    container_name: mytube
    restart: always
    command: gunicorn mytube.wsgi:application --bind 0.0.0.0:8000
    expose: 
      - "8000"
    volumes:
      - ./mytube/static:/app/static
    env_file:
      - ./mytube/.env
    environment:
      - DEBUG=False
    depends_on:
      - postgres
    
  recommendation_service:
    build: ./recommendation_service
    container_name: recommendation_service
    restart: always
    command: gunicorn recommendation_service.wsgi:application --bind 0.0.0.0:7000
    expose: 
      - "7000"
    env_file:
      - ./recommendation_service/.env
    environment:
      - DEBUG=False
    depends_on:
      - mongo

  # BACKGROUND WORKER # 
  celery_worker:
    build: ./mytube
    container_name: celery_worker
    restart: always
    command: celery -A mytube worker --loglevel=info
    env_file:
      - ./mytube/.env
    environment:
      - DEBUG=False
      - RECOMMENDATION_SERVICE_URL=http://recommendation_service:7000
    depends_on:
      - recommendation_service
      - postgres

  # PROXY SERVER #
  nginx:
    image: nginx:stable
    restart: always
    container_name: nginx
    ports: 
      - "8000:80"
    volumes:
      - ./config/deploy/nginx.conf:/etc/nginx/nginx.conf
      - ./config/ssl:/etc/ssl
      - ./mytube/static:/app/static
    depends_on:
      - mytube

volumes:
  postgres_data:
  mongo_data: